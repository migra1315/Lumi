# 巡检机器人控制系统技术文档

## 1. 系统概述

### 1.1 系统简介

巡检机器人控制系统是一个用于管理和控制巡检机器人的核心系统，负责接收后台指令、执行任务、回传状态信息等功能。系统支持多种工作模式，能够处理复杂的巡检任务和服务任务。

### 1.2 系统架构

系统采用分层架构设计，各层之间通过明确的接口进行交互，便于扩展和维护。

```
┌─────────────────────────────────────────────────────────────────┐
│                         后台服务器                           │
└─────────────────────────────────────────────────────────────────┘
                                  ▲
                                  │ 通信协议（WebSocket/MQTT）
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                      通信层（Communication Layer）              │
│  - 指令接收与解析                                              │
│  - 状态信息回传                                                │
└─────────────────────────────────────────────────────────────────┘
                                  ▲
                                  │ 消息队列/事件机制
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                       控制层（Control Layer）                  │
│  - 核心控制系统（RobotControlSystem）                          │
│  - 工作模式管理                                              │
│  - 任务协调与调度                                            │
└─────────────────────────────────────────────────────────────────┘
                                  ▲
                                  │ 任务接口
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                       任务层（Task Layer）                     │
│  - 任务管理器（TaskManager）                                  │
│  - 任务调度器（TaskScheduler）                                │
│  - 任务执行器                                                │
└─────────────────────────────────────────────────────────────────┘
                                  ▲
                                  │ 机器人控制接口
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                     机器人层（Robot Layer）                    │
│  - 机器人控制器（RobotController）                            │
│  - AGV控制器（AGVController）                                │
│  - 机械臂控制器（ArmController）                              │
│  - Mock机器人控制器                                          │
└─────────────────────────────────────────────────────────────────┘
                                  ▲
                                  │ 数据访问接口
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                       数据层（Data Layer）                     │
│  - 任务数据库（TaskDatabase）                                  │
│  - 机器人消息存储                                            │
│  - 状态数据存储                                              │
└─────────────────────────────────────────────────────────────────┘
```

### 1.3 核心功能

| 功能模块 | 主要职责 |
|----------|----------|
| 指令接收与解析 | 接收后台指令，解析后执行相应操作 |
| 任务管理 | 管理任务队列，按优先级和顺序执行任务 |
| 状态回传 | 定时向后台回传机器人状态、环境数据和设备信息 |
| 多模式支持 | 支持inspection和service两种工作模式 |
| 错误处理 | 处理各种错误场景，确保系统稳定运行 |
| 数据持久化 | 将任务信息和通信数据保存到数据库 |

## 2. 核心组件设计

### 2.1 RobotControlSystem

**功能**：核心控制系统，负责协调各模块工作，处理指令和状态回传。

**主要属性**：
- `robot_id`：机器人唯一标识
- `current_mode`：当前工作模式
- `is_running`：系统运行状态
- `robot_controller`：机器人控制器实例
- `task_manager`：任务管理器实例

**主要方法**：
- `start()`：启动控制系统
- `stop()`：停止控制系统
- `handle_command()`：处理接收到的指令
- `_report_robot_status()`：上报机器人状态
- `_report_environment_data()`：上报环境数据

**工作流程**：
1. 初始化机器人控制器和任务管理器
2. 启动通信接收线程和定时上报线程
3. 接收后台指令，解析后执行相应操作
4. 根据工作模式处理任务
5. 定时向后台回传状态信息

### 2.2 TaskManager

**功能**：任务管理，负责接收、存储和分配任务。

**主要属性**：
- `robot_controller`：机器人控制器实例
- `database`：数据库实例
- `scheduler`：任务调度器实例

**主要方法**：
- `receive_task_from_cmd()`：从TaskCmd接收任务
- `receive_task_from_json()`：从JSON接收任务
- `get_task_status()`：获取任务状态
- `get_all_tasks()`：获取所有任务

### 2.3 TaskScheduler

**功能**：任务调度，负责按照优先级和顺序执行任务。

**主要属性**：
- `task_queue`：优先级任务队列
- `current_task`：当前执行的任务
- `is_running`：调度器运行状态

**主要方法**：
- `add_task()`：添加任务到队列
- `_execute_task()`：执行任务
- `_execute_station_task()`：执行单个站点任务
- `_execute_operation()`：执行特定操作

**任务执行流程**：
1. 从任务队列中获取下一个任务
2. 更新任务状态为RUNNING
3. 执行站点任务：
   - 移动AGV到指定标记点
   - 移动机械臂到归位位置
   - 移动外部轴到归位位置
   - 执行操作模式（如拍照、开门等）
4. 更新任务状态为COMPLETED或FAILED
5. 触发任务完成回调

### 2.4 TaskDatabase

**功能**：数据库管理，负责存储和管理任务信息和通信数据。

**数据库表设计**：

#### 2.4.1 tasks表

| 字段名 | 类型 | 描述 |
|--------|------|------|
| task_id | TEXT | 任务ID |
| stations_json | TEXT | 站点任务JSON |
| priority | INTEGER | 任务优先级 |
| status | TEXT | 任务状态 |
| created_at | TIMESTAMP | 创建时间 |
| started_at | TIMESTAMP | 开始时间 |
| completed_at | TIMESTAMP | 完成时间 |
| retry_count | INTEGER | 重试次数 |
| max_retries | INTEGER | 最大重试次数 |
| error_message | TEXT | 错误信息 |
| metadata_json | TEXT | 元数据JSON |

#### 2.4.2 robot_received_messages表

| 字段名 | 类型 | 描述 |
|--------|------|------|
| msg_id | TEXT | 消息ID |
| msg_time | INTEGER | 消息时间戳 |
| cmd_type | TEXT | 命令类型 |
| robot_id | TEXT | 机器人ID |
| data_json | TEXT | 消息数据JSON |
| received_at | TIMESTAMP | 接收时间 |
| processed | BOOLEAN | 是否已处理 |

#### 2.4.3 robot_sent_messages表

| 字段名 | 类型 | 描述 |
|--------|------|------|
| msg_id | TEXT | 消息ID |
| msg_time | INTEGER | 消息时间戳 |
| msg_type | TEXT | 消息类型 |
| robot_id | TEXT | 机器人ID |
| data_json | TEXT | 消息数据JSON |
| sent_at | TIMESTAMP | 发送时间 |
| status | TEXT | 发送状态 |

## 3. 数据模型

### 3.1 命令模型（CommandModels）

#### 3.1.1 CommandEnvelope

命令信封，所有指令的包装器。

| 字段名 | 类型 | 描述 |
|--------|------|------|
| cmdId | TEXT | 唯一消息ID |
| cmdTime | INTEGER | 消息产生的时间戳（毫秒） |
| cmdType | CmdType | 命令类型 |
| robotId | TEXT | 机器人标识 |
| dataJson | Dict[str, Any] | 实际的功能数据 |

#### 3.1.2 TaskCmd

任务下发命令。

| 字段名 | 类型 | 描述 |
|--------|------|------|
| taskId | TEXT | 任务ID |
| taskName | TEXT | 任务名称 |
| robotMode | RobotMode | 机器人模式 |
| stationTasks | List[StationConfig] | 站点任务列表 |
| generateTime | datetime | 任务生成时间 |

### 3.2 消息模型（MessageModels）

#### 3.2.1 MessageEnvelope

消息信封，所有状态信息的包装器。

| 字段名 | 类型 | 描述 |
|--------|------|------|
| msgId | TEXT | 唯一消息ID |
| msgTime | INTEGER | 消息产生的时间戳（毫秒） |
| msgType | MsgType | 消息类型 |
| robotId | TEXT | 机器人标识 |
| dataJson | Dict[str, Any] | 实际的功能数据 |

#### 3.2.2 RobotStatusDataJson

机器人状态数据。

| 字段名 | 类型 | 描述 |
|--------|------|------|
| batteryInfo | BatteryInfo | 电池信息 |
| positionInfo | PositionInfo | 位置信息 |
| taskInfo | TasksInfo | 任务信息 |
| systemStatus | SystemStatus | 系统状态 |
| errorInfo | Optional[ErrorInfo] | 错误信息 |

### 3.3 任务模型（TaskModels）

#### 3.3.1 Task

巡检任务。

| 字段名 | 类型 | 描述 |
|--------|------|------|
| task_id | TEXT | 任务ID |
| station | StationConfig | 单个站点 |
| priority | int | 优先级 |
| status | TaskStatus | 任务状态 |
| created_at | datetime | 创建时间 |
| started_at | Optional[datetime] | 开始时间 |
| completed_at | Optional[datetime] | 完成时间 |
| retry_count | int | 重试次数 |
| max_retries | int | 最大重试次数 |
| error_message | Optional[str] | 错误信息 |
| metadata | Dict[str, Any] | 元数据 |

## 4. API接口

### 4.1 命令接口

| 命令类型 | 功能描述 | 数据格式 |
|----------|----------|----------|
| TASK_CMD | 任务下发 | TaskCmd |
| ROBOT_MODE_CMD | 机器人模式切换 | RobotModeCmd |
| JOY_CONTROL_CMD | 摇杆控制 | joyControlCmd |
| CHARGE_CMD | 充电命令 | ChargeCmd |
| SET_MARKER_CMD | 设置标记 | SetMarkerCmd |

### 4.2 消息接口

| 消息类型 | 功能描述 | 数据格式 |
|----------|----------|----------|
| ROBOT_STATUS | 机器人状态 | RobotStatusDataJson |
| DEVICE_DATA | 巡检设备状态 | DeviceDataJson |
| ENVIRONMENT_DATA | 巡检环境信息 | EnvironmentDataJson |
| ARRIVE_SERVER_POINT | 到达服务点 | ArriveServePointDataJson |

## 5. 工作流程

### 5.1 系统启动流程

1. 初始化RobotControlSystem
2. 初始化机器人控制器
3. 初始化任务管理器
4. 启动通信接收线程
5. 启动定时上报线程
6. 等待接收指令

### 5.2 指令处理流程

1. 接收后台指令
2. 解析CommandEnvelope
3. 根据cmdType调用相应的处理函数
4. 执行命令
5. 回传执行结果

### 5.3 任务执行流程

1. 接收TaskCmd指令
2. 解析任务信息
3. 为每个站点创建Task对象
4. 添加任务到调度器
5. 调度器按优先级执行任务
6. 执行站点任务：
   - 移动AGV到标记点
   - 移动机械臂到归位位置
   - 移动外部轴到归位位置
   - 执行操作模式
7. 回传执行结果

### 5.4 状态上报流程

1. 定时触发状态上报
2. 采集机器人状态数据
3. 构建MessageEnvelope
4. 发送到后台
5. 保存到数据库

## 6. 错误处理

### 6.1 错误类型

| 错误类型 | 描述 | 处理方式 |
|----------|------|----------|
| 通信错误 | 与后台通信失败 | 重试机制，记录日志 |
| 任务执行错误 | 任务执行失败 | 重试机制，记录错误信息 |
| 机器人错误 | 机器人执行失败 | 错误恢复，重置错误状态 |
| 数据库错误 | 数据库操作失败 | 重试机制，记录日志 |

### 6.2 错误恢复机制

1. **通信错误**：
   - 重试发送/接收
   - 记录错误日志
   - 触发通信错误回调

2. **任务执行错误**：
   - 检查重试次数
   - 如果未达到最大重试次数，重新添加到队列
   - 否则标记为FAILED

3. **机器人错误**：
   - 调用reset_errors()重置错误状态
   - 重新尝试执行
   - 记录错误信息

## 7. 配置说明

### 7.1 系统配置

系统配置文件位于 `conf/control.json`，主要配置项包括：

```json
{
  "robot_id": "ROBOT_001",
  "use_mock": true,
  "robot_config": {
    "success_rate": 0.95,
    "latency": 0.1
  },
  "report_interval": {
    "status": 10,  // 机器人状态上报间隔（秒）
    "environment": 30  // 环境数据上报间隔（秒）
  }
}
```

### 7.2 数据库配置

数据库配置在 `TaskDatabase.py` 中，可通过构造函数参数调整：

```python
db = TaskDatabase(db_path="tasks.db")
```

## 8. 测试与调试

### 8.1 运行测试

```bash
# 运行控制系统
python RobotControlSystem.py

# 运行特定模块测试
python -m task.TaskManager
```

### 8.2 日志配置

系统使用Python标准库的logging模块，可通过配置调整日志级别和输出格式。

### 8.3 调试技巧

1. **查看日志**：检查日志文件或控制台输出
2. **断点调试**：使用IDE设置断点进行调试
3. **模拟场景**：使用MockRobotController模拟各种场景
4. **数据库检查**：查看数据库中的任务和消息记录

## 9. 扩展与维护

### 9.1 添加新的命令类型

1. 在 `CommandModels.py` 中添加新的命令类
2. 更新 `_CMD_TYPE_TO_DATA_CLASS` 映射
3. 在 `RobotControlSystem.py` 中添加命令处理逻辑

### 9.2 添加新的消息类型

1. 在 `MessageModels.py` 中添加新的消息类
2. 更新 `_MSG_TYPE_TO_DATA_CLASS` 映射
3. 在 `RobotControlSystem.py` 中添加消息生成逻辑

### 9.3 添加新的操作模式

1. 在 `TaskModels.py` 的 `OperationMode` 中添加新的操作模式
2. 在 `TaskScheduler.py` 的 `_execute_operation` 方法中添加处理逻辑

## 10. 性能优化

### 10.1 并发处理

- 使用多线程处理通信和任务执行
- 任务调度器使用线程池执行任务
- 避免阻塞主线程

### 10.2 数据库优化

- 使用事务处理批量操作
- 合理设计索引
- 定期清理过期数据

### 10.3 通信优化

- 使用异步通信协议
- 合理设置消息优先级
- 实现消息压缩

## 11. 安全考虑

### 11.1 通信安全

- 使用加密通信协议（如WSS/MQTTS）
- 实现消息认证和授权
- 防止消息篡改

### 11.2 数据安全

- 敏感数据加密存储
- 定期备份数据库
- 实现访问控制

### 11.3 系统安全

- 防止未授权访问
- 实现安全审计
- 定期更新系统和依赖

## 12. 总结

巡检机器人控制系统采用分层架构设计，具有良好的扩展性和维护性。系统实现了指令接收、任务管理、状态回传等核心功能，支持多种工作模式，能够满足巡检机器人的控制需求。

系统使用Python开发，依赖简单，易于部署和运行。通过合理的设计和优化，系统能够稳定运行，处理复杂的巡检任务。

未来可以进一步扩展功能，如添加更多的操作模式、实现更复杂的任务调度策略、优化通信协议等，以适应更复杂的应用场景。