# 回调函数说明文档

## 文档概述

本文档描述了 Lumi 机器人控制系统中的回调函数机制，包括回调函数的定义、触发时机、调用路径和使用方法。

**最后更新时间**: 2026-01-09
**重构版本**: v2.0 (统一回调路径)

---

## 系统架构与回调层级

系统采用分层回调机制，确保事件从底层传递到上层：

```
TaskScheduler (调度层)
    ↓ 触发回调
TaskManager (管理层)
    ↓ 触发系统回调
RobotControlSystem (通信层)
    ↓ 上报数据到服务器
```

**设计原则**:
- **单向传递**: 回调事件从下层向上层传递，避免循环调用
- **职责分离**: 每层只处理自己职责范围内的逻辑
- **解耦设计**: 通过回调机制实现层间解耦

---

## 1. TaskScheduler 回调函数

### 1.1 任务级回调

#### `on_task_start`
- **触发时机**: 任务开始执行时
- **触发位置**: `TaskScheduler._execute_task()` (line 210)
- **回调参数**: `task: Task` - 任务对象
- **注册位置**: `TaskManager.__init__()` (line 38)
- **处理函数**: `TaskManager._on_task_start()`
- **用途**: 记录任务开始日志，可用于发送通知或更新UI

#### `on_task_complete`
- **触发时机**: 任务完成时（所有站点执行完毕）
- **触发位置**: `TaskScheduler._task_execution_done()` (line 397, 404)
- **回调参数**: `task: Task` - 任务对象
- **注册位置**: `TaskManager.__init__()` (line 39)
- **处理函数**: `TaskManager._on_task_complete()`
- **用途**:
  - 记录任务完成日志
  - 触发系统回调 `on_data_ready` (data_type="task_complete")
  - 用于上报任务统计数据

#### `on_task_failed`
- **触发时机**: 任务执行失败时
- **触发位置**: `TaskScheduler._task_execution_done()` (line 416)
- **回调参数**: `task: Task` - 任务对象
- **注册位置**: `TaskManager.__init__()` (line 40)
- **处理函数**: `TaskManager._on_task_failed()`
- **用途**: 记录任务失败日志，可用于发送告警通知

### 1.2 站点级回调

#### `on_station_start`
- **触发时机**: 站点任务开始执行时
- **触发位置**: `TaskScheduler._execute_station_task()` (line 271)
- **回调参数**: `station: Station` - 站点对象
- **注册位置**: `TaskManager.__init__()` (line 41)
- **处理函数**: `TaskManager._on_station_start()`
- **用途**:
  - 记录站点开始日志
  - 触发系统回调 `on_arrive_station`
  - 用于上报到达服务点信息

#### `on_station_complete`
- **触发时机**: 站点任务完成时
- **触发位置**: `TaskScheduler._execute_station_task()` (line 324)
- **回调参数**: `station: Station` - 站点对象
- **注册位置**: `TaskManager.__init__()` (line 42)
- **处理函数**: `TaskManager._on_station_complete()`
- **用途**:
  - 记录站点完成日志
  - 触发系统回调 `on_data_ready` (data_type="device_data")
  - 用于上报设备采集数据（如图像）

#### `on_station_retry`
- **触发时机**: 站点任务需要重试时
- **触发位置**: `TaskScheduler._retry_station_task()` (line 353)
- **回调参数**: `station: Station` - 站点对象
- **注册位置**: `TaskManager.__init__()` (line 43)
- **处理函数**: `TaskManager._on_station_retry()`
- **用途**: 记录站点重试日志，可用于监控和告警

### 1.3 命令级回调

#### `on_command_complete`
- **触发时机**: 命令执行完成时
- **触发位置**: `TaskScheduler._command_execution_done()` (line 163)
- **回调参数**: `command: UnifiedCommand` - 统一命令对象
- **注册位置**: 当前未注册（预留接口）
- **用途**: 用于统一命令系统的完成通知

#### `on_command_failed`
- **触发时机**: 命令执行失败时（达到最大重试次数）
- **触发位置**: `TaskScheduler._command_execution_done()` (line 186)
- **回调参数**: `command: UnifiedCommand` - 统一命令对象
- **注册位置**: 当前未注册（预留接口）
- **用途**: 用于统一命令系统的失败通知

---

## 2. TaskManager 系统回调函数

### 2.1 系统级回调（供外部注册）

#### `on_data_ready`
- **触发时机**:
  - 任务完成时 (`_on_task_complete`)
  - 站点完成时 (`_on_station_complete`)
- **触发位置**:
  - `TaskManager._on_task_complete()` (line 468-472)
  - `TaskManager._on_station_complete()` (line 491-495)
- **回调参数**:
  - `data_type`: str - 数据类型 ("task_complete" 或 "device_data")
  - `task`: Task (可选) - 任务对象
  - `station`: Station (可选) - 站点对象
- **注册位置**: `RobotControlSystem.__init__()` (line 68)
- **处理函数**: `RobotControlSystem._handle_data_ready_callback()`
- **用途**:
  - data_type="device_data": 上报设备数据（如采集的图像）
  - data_type="task_complete": 上报任务统计数据

#### `on_arrive_station`
- **触发时机**: 机器人到达站点时
- **触发位置**: `TaskManager._on_station_start()` (line 484-487)
- **回调参数**:
  - `station`: Station - 站点对象
- **注册位置**: `RobotControlSystem.__init__()` (line 69)
- **处理函数**: `RobotControlSystem._handle_arrive_station_callback()`
- **用途**: 上报到达服务点信息 (MsgType.ARRIVE_SERVER_POINT)

---

## 3. RobotControlSystem 回调函数

### 3.1 通信回调（供外部注册）

#### `on_command_received`
- **触发时机**: 收到服务器命令时
- **触发位置**: `RobotControlSystem._handle_command()` (line 330)
- **回调参数**: `command_dict: Dict[str, Any]` - 命令字典
- **注册方式**: `robot_system.register_callback("on_command_received", callback_func)`
- **用途**: 外部模块监听命令接收事件

#### `on_status_reported`
- **触发时机**: 状态上报完成时
- **触发位置**: `RobotControlSystem._report_robot_status()` (line 466)
- **回调参数**: `msg_dict: Dict[str, Any]` - 消息字典
- **注册方式**: `robot_system.register_callback("on_status_reported", callback_func)`
- **用途**: 外部模块监听状态上报事件

---

## 4. AGVController 回调函数

### 4.1 数据接收回调

#### `agv_data_callback`
- **触发时机**: AGV 持续数据接收时
- **设置方式**: 通过 `AGVController` 初始化配置
- **回调参数**: AGV 数据流
- **用途**: 处理 AGV 发送的实时数据流（位置、状态等）

---

## 5. 回调函数调用路径示例

### 5.1 任务完成的完整调用链

```
1. TaskScheduler._task_execution_done()
   ↓
2. _trigger_callback("on_task_complete", task)
   ↓
3. TaskManager._on_task_complete(task)
   ↓
4. _trigger_system_callback("on_data_ready", data_type="task_complete", task=task)
   ↓
5. RobotControlSystem._handle_data_ready_callback(data_type="task_complete", task=task)
   ↓
6. (可选) 上报任务统计数据到服务器
```

### 5.2 站点完成的完整调用链

```
1. TaskScheduler._execute_station_task()
   ↓
2. _trigger_callback("on_station_complete", station)
   ↓
3. TaskManager._on_station_complete(station)
   ↓
4. _trigger_system_callback("on_data_ready", data_type="device_data", station=station)
   ↓
5. RobotControlSystem._handle_data_ready_callback(data_type="device_data", station=station)
   ↓
6. _report_device_data(station)
   ↓
7. 通过 gRPC 上报设备数据到服务器
```

### 5.3 到达站点的完整调用链

```
1. TaskScheduler._execute_station_task()
   ↓
2. _trigger_callback("on_station_start", station)
   ↓
3. TaskManager._on_station_start(station)
   ↓
4. _trigger_system_callback("on_arrive_station", station=station)
   ↓
5. RobotControlSystem._handle_arrive_station_callback(station=station)
   ↓
6. _report_arrive_service_point(station)
   ↓
7. 通过 gRPC 上报到达服务点信息
```

---

## 6. 如何注册自定义回调

### 6.1 注册到 TaskScheduler

```python
# 在 TaskManager 或其他模块中
task_manager.scheduler.register_callback("on_task_complete", my_callback_func)

def my_callback_func(task: Task):
    print(f"Task {task.task_id} completed!")
```

### 6.2 注册到 TaskManager 系统回调

```python
# 在 RobotControlSystem 或其他模块中
task_manager.register_system_callback("on_data_ready", my_data_ready_handler)

def my_data_ready_handler(data_type: str, **kwargs):
    if data_type == "device_data":
        station = kwargs.get("station")
        print(f"Device data ready for station {station.station_config.station_id}")
```

### 6.3 注册到 RobotControlSystem

```python
# 在外部模块中
robot_system.register_callback("on_command_received", my_command_handler)

def my_command_handler(command_dict: Dict[str, Any]):
    print(f"Received command: {command_dict}")
```

---

## 7. 重构历史

### 7.1 重构前的问题

1. **重复注册**: `RobotControlSystem` 同时注册到 `TaskScheduler` 和 `TaskManager`，导致回调被调用两次
2. **未使用的回调**:
   - `RobotControllerBase` 中定义了5个回调但从未使用
   - `TaskManager` 中的 `on_command_complete` 和 `on_command_failed` 未被使用
   - `TaskScheduler` 中的 `on_station_failed` 注册但从未触发
   - `RobotControlSystem` 中的 `on_communication_error` 未被使用
3. **调用链过长**: 同一事件通过多条路径传递，造成混乱

### 7.2 重构后的改进

1. **统一回调路径**: TaskScheduler → TaskManager → RobotControlSystem
2. **删除重复注册**: `RobotControlSystem` 只注册到 `TaskManager` 系统回调
3. **清理未使用回调**: 删除所有未使用的回调定义和注册
4. **简化回调系统**:
   - `RobotControllerBase`: 删除所有回调机制
   - `TaskManager`: 只保留2个系统回调 (on_data_ready, on_arrive_station)
   - `TaskScheduler`: 保留8个实际使用的回调
   - `RobotControlSystem`: 保留2个外部回调 (on_command_received, on_status_reported)

### 7.3 删除的回调列表

- `RobotControllerBase.callbacks`: 全部删除（5个）
  - on_status_change
  - on_battery_change
  - on_error
  - on_task_start
  - on_task_complete
- `TaskManager.system_callbacks`: 删除2个
  - on_command_complete
  - on_command_failed
- `TaskScheduler.task_callbacks`: 删除1个
  - on_station_failed
- `RobotControlSystem.callbacks`: 删除2个
  - on_task_executed
  - on_communication_error
- `RobotControlSystem` 直接注册到 `TaskScheduler` 的回调（2个）
  - _on_task_complete
  - _on_task_failed

---

## 8. 最佳实践

### 8.1 回调函数命名规范

- 内部回调（供本模块使用）: `_on_xxx()` （私有方法）
- 外部回调（供外部注册）: 事件名称使用 `on_xxx` （字符串）
- 处理函数: `_handle_xxx_callback()` 或 `_on_xxx()`

### 8.2 回调函数设计原则

1. **单一职责**: 每个回调只处理一件事
2. **异常处理**: 回调内部应捕获异常，避免影响主流程
3. **避免阻塞**: 回调应该快速执行，耗时操作应异步处理
4. **参数明确**: 回调参数应该明确、完整，避免隐式依赖

### 8.3 触发回调的注意事项

```python
# ✅ 正确：使用 _trigger_callback 触发
self._trigger_callback("on_task_complete", task)

# ❌ 错误：直接调用回调列表
for callback in self.task_callbacks["on_task_complete"]:
    callback(task)  # 缺少异常处理
```

### 8.4 注册回调的注意事项

```python
# ✅ 正确：在初始化时注册
def __init__(self):
    self.task_manager.register_system_callback("on_data_ready", self._handler)

# ❌ 错误：重复注册同一个回调
def method1(self):
    self.task_manager.register_system_callback("on_data_ready", self._handler)
def method2(self):
    self.task_manager.register_callback("on_data_ready", self._handler)  # 重复！
```

---

## 9. 常见问题 FAQ

### Q1: 为什么删除了 `on_station_failed` 回调？
A: 代码审查发现该回调已注册但从未被触发（触发代码被注释）。当前系统使用重试机制处理站点失败，失败后会自动重试直到成功或达到最大重试次数。

### Q2: `on_command_complete` 和 `on_command_failed` 为什么被删除？
A: 这两个回调在 `TaskManager` 中定义但从未被注册使用。统一命令系统的状态跟踪已通过数据库和日志实现，不需要额外的回调通知。

### Q3: 如何添加新的回调事件？
A: 按照以下步骤：
1. 在对应模块的回调字典中添加事件名称
2. 在适当的位置调用 `_trigger_callback(event_name, args)`
3. 在上层模块注册处理函数
4. 更新本文档

### Q4: 回调函数执行异常会影响主流程吗？
A: 不会。所有 `_trigger_callback` 方法都包含异常捕获，回调异常只会记录日志，不会中断主流程。

---

## 10. 相关文档

- [系统总体架构](./系统总体架构.md)
- [重构完成总结](../重构完成总结.md)
- [重构任务大纲](../重构任务大纲.md)

---

**文档维护者**: Lumi Development Team
**联系方式**: 请通过 GitHub Issues 反馈问题
