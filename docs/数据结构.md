# 机器人通信协议数据模型技术文档

## 1. 概述

本系统定义了机器人与服务器之间的通信数据模型，采用请求-响应模式的双向通信架构：

- **上行消息**：机器人作为客户端向服务器上传状态和数据，使用 `MessageModels.py` 中定义的数据结构
- **下行命令**：客户端（服务器）向机器人下发控制指令，使用 `CommandModels.py` 中定义的数据结构
- **任务模型**：巡检和服务任务的核心数据定义在 `TaskModels.py` 中

## 2. 数据流架构

```
┌─────────────────┐          ┌─────────────────┐
│     服务器       │          │      机器人      │
│                 │          │                 │
│   CommandModels │◄─────────│  MessageModels  │
│   (下发命令)     │          │   (上报数据)    │
│                 │          │                 │
└─────────────────┘          └─────────────────┘
         │                           │
         └─────► TaskModels ◄────────┘
                (任务数据模型)
```

## 3. 命令模型（CommandModels.py）

### 3.1 枚举类型

#### CmdType - 命令类型
| 值 | 描述 |
|----|------|
| `RESPONSE_CMD` | 响应命令 |
| `ROBOT_MODE_CMD` | 机器人模式命令 |
| `TASK_CMD` | 任务下发命令 |

#### RobotMode - 机器人模式
| 值 | 描述 |
|----|------|
| `INSPECTION` ("normal") | 正常巡检模式 |
| `SERVICE` ("service") | 服务模式 |
| `ESTOP` ("estop") | 紧急停止模式 |

### 3.2 数据结构

#### ResponseCmd - 响应命令
用于机器人对服务器命令的响应。

| 字段 | 类型 | 描述 |
|------|------|------|
| `code` | `str` | 命令ID，用于匹配请求 |
| `info` | `str` | 响应状态（如 "success"、"error"） |

#### RobotModeCmd - 机器人模式命令
用于切换机器人工作模式。

| 字段 | 类型 | 描述 |
|------|------|------|
| `robotMode` | `RobotMode` | 目标机器人模式 |

#### TaskCmd - 任务下发命令
用于下发巡检或服务任务。

| 字段 | 类型 | 描述 |
|------|------|------|
| `taskId` | `str` | 任务唯一标识符 |
| `taskName` | `str` | 任务名称 |
| `robotMode` | `RobotMode` | 执行任务时的机器人模式 |
| `generateTime` | `datetime` | 任务生成时间 |
| `stationTasks` | `List[StationConfig]` | 站点任务列表（见TaskModels） |

### 3.3 消息包装器

#### CommandEnvelope - 命令信封
所有下行命令的统一包装器。

| 字段 | 类型 | 描述 |
|------|------|------|
| `cmdId` | `str` | 唯一消息ID，用于请求响应匹配和消息去重 |
| `cmdTime` | `int` | 消息产生的时间戳（毫秒） |
| `cmdType` | `CmdType` | 核心路由字段，标识功能类型 |
| `robotId` | `str` | 机器人标识，用于会话管理和消息路由 |
| `dataJson` | `Dict[str, Any]` | 实际的功能数据JSON |

### 3.4 辅助函数

```python
# 创建任务下发消息信封
create_task_cmd_envelope(cmd_id: str, robot_id: str, task_cmd: TaskCmd) -> CommandEnvelope

# 创建响应消息信封
create_response_cmd_envelope(cmd_id: str, robot_id: str, response_cmd: ResponseCmd) -> CommandEnvelope

# 创建机器人模式命令消息信封
create_robot_mode_cmd_envelope(cmd_id: str, robot_id: str, robot_mode_cmd: RobotModeCmd) -> CommandEnvelope
```

## 4. 消息模型（MessageModels.py）

### 4.1 枚举类型

#### MsgType - 消息类型
| 值 | 描述 |
|----|------|
| `ROBOT_STATUS` | 机器人状态 |
| `DEVICE_DATA` | 巡检设备状态 |
| `ENVIRONMENT_DATA` | 巡检环境信息 |
| `ARRIVE_SERVER_POINT` | 到达服务器点通知 |

#### MoveStatus - 机器人移动状态
| 值 | 描述 |
|----|------|
| `IDLE` | 空闲状态，未接收移动指令 |
| `RUNNING` | 正在执行移动任务 |
| `SUCCEEDED` | 移动任务成功完成 |
| `FAILED` | 移动任务失败 |
| `CANCELED` | 移动任务被取消 |

### 4.2 核心数据结构

#### BatteryInfo - 电池信息
| 字段 | 类型 | 描述 |
|------|------|------|
| `power_percent` | `float` | 剩余电量百分比 |
| `charge_status` | `str` | 充电状态（充电中/放电中） |

#### PositionInfo - 位置信息
| 字段 | 类型 | 描述 |
|------|------|------|
| `AGVPositionInfo` | `List[float]` | AGV位置 [x, y, theta] |
| `ARMPositionInfo` | `List[float]` | 机械臂关节位置 [J1-J6] |
| `EXTPositionInfo` | `List[float]` | 外部轴位置 [J1-J4] |
| `targetPoint` | `str` | 目标点位名称 |
| `pointId` | `Optional[str]` | 点位ID（可选） |

#### TaskInfo - 任务信息
| 字段 | 类型 | 描述 |
|------|------|------|
| `inspection_task_list` | `List[Task]` | 巡检任务列表 |

#### SystemStatus - 系统状态
| 字段 | 类型 | 描述 |
|------|------|------|
| `move_status` | `MoveStatus` | 机器人移动状态 |
| `is_connected` | `bool` | 通信连接状态 |
| `soft_estop_status` | `bool` | 软急停状态 |
| `hard_estop_status` | `bool` | 硬急停状态 |
| `estop_status` | `bool` | 急停状态（综合） |

### 4.3 数据集合

#### RobotStatusDataJson - 机器人状态数据
| 字段 | 类型 | 描述 |
|------|------|------|
| `batteryInfo` | `BatteryInfo` | 电池信息 |
| `positionInfo` | `PositionInfo` | 位置信息 |
| `taskInfo` | `TaskInfo` | 任务信息 |
| `systemStatus` | `SystemStatus` | 系统状态 |
| `errorInfo` | `Optional[ErrorInfo]` | 错误信息（可选） |

#### DeviceDataJson - 设备巡检数据
| 字段 | 类型 | 描述 |
|------|------|------|
| `positionInfo` | `PositionInfo` | 位置信息 |
| `taskInfo` | `TaskInfo` | 任务信息 |
| `deviceInfo` | `DeviceInfo` | 设备检测数据 |

#### EnvironmentDataJson - 环境巡检数据
| 字段 | 类型 | 描述 |
|------|------|------|
| `positionInfo` | `PositionInfo` | 位置信息 |
| `taskInfo` | `TaskInfo` | 任务信息 |
| `environmentInfo` | `EnvironmentInfo` | 环境检测数据 |

### 4.4 消息包装器

#### MessageEnvelope - 消息信封
所有上行消息的统一包装器。

| 字段 | 类型 | 描述 |
|------|------|------|
| `msgId` | `str` | 唯一消息ID |
| `msgTime` | `int` | 消息产生时间戳（毫秒） |
| `msgType` | `MsgType` | 消息类型，标识功能 |
| `robotId` | `str` | 机器人标识 |
| `dataJson` | `Dict[str, Any]` | 实际功能数据JSON |

### 4.5 辅助函数

```python
# 创建机器人状态消息
create_robot_status_message(
    msg_id: str, robot_id: str, battery_info: BatteryInfo,
    position_info: PositionInfo, task_info: List[TaskInfo],
    system_status: SystemStatus, error_info: Optional[ErrorInfo] = None
) -> MessageEnvelope

# 创建设备巡检数据消息
create_device_data_message(
    msg_id: str, robot_id: str, position_info: PositionInfo,
    task_info: List[TaskInfo], device_info: DeviceInfo
) -> MessageEnvelope

# 创建环境巡检数据消息
create_environment_data_message(
    msg_id: str, robot_id: str, position_info: PositionInfo,
    task_info: List[TaskInfo], environment_info: EnvironmentInfo
) -> MessageEnvelope
```

## 5. 任务模型（TaskModels.py）

### 5.1 枚举类型

#### TaskStatus - 任务状态
| 值 | 描述 |
|----|------|
| `PENDING` | 待执行 |
| `RUNNING` | 执行中 |
| `COMPLETED` | 已完成 |
| `FAILED` | 执行失败 |
| `SKIPPED` | 已跳过 |
| `RETRYING` | 重试中 |

#### OperationMode - 操作模式
| 值 | 描述 |
|----|------|
| `OPEN_DOOR` | 打开门 |
| `CLOSE_DOOR` | 关闭门 |
| `NONE` | 无操作 |
| `CAPTURE` | 拍照 |
| `SERVE` | 服务 |

### 5.2 核心数据结构

#### OperationConfig - 操作配置
| 字段 | 类型 | 描述 |
|------|------|------|
| `operation_mode` | `OperationMode` | 操作模式 |
| `door_ip` | `Optional[str]` | 门禁IP地址 |
| `device_id` | `Optional[str]` | 设备ID |

#### StationConfig - 站点配置
| 字段 | 类型 | 描述 |
|------|------|------|
| `station_id` | `str` | 站点ID（如"station1"） |
| `sort` | `int` | 站点执行顺序 |
| `name` | `str` | 站点名称 |
| `agv_marker` | `str` | AGV导航点标识 |
| `robot_pos` | `List[float]` | 机械臂归位位置 |
| `ext_pos` | `List[float]` | 外部轴归位位置 |
| `operation_config` | `OperationConfig` | 操作任务配置 |

#### Task - 巡检任务
| 字段 | 类型 | 描述 | 默认值 |
|------|------|------|--------|
| `task_id` | `str` | 任务唯一标识符 | - |
| `station` | `StationConfig` | 站点配置 | - |
| `priority` | `int` | 优先级(1-10,10最高) | 1 |
| `status` | `TaskStatus` | 任务状态 | `PENDING` |
| `created_at` | `datetime` | 创建时间 | 当前时间 |
| `started_at` | `Optional[datetime]` | 开始时间 | `None` |
| `completed_at` | `Optional[datetime]` | 完成时间 | `None` |
| `retry_count` | `int` | 重试次数 | 0 |
| `max_retries` | `int` | 最大重试次数 | 3 |
| `error_message` | `Optional[str]` | 错误信息 | `None` |
| `metadata` | `Dict[str, Any]` | 元数据 | `{}` |

## 6. 通信协议示例

### 6.1 下行命令示例（服务器→机器人）

**任务下发命令：**
```json
{
  "cmdId": "cmd_001",
  "cmdTime": 1672531200000,
  "cmdType": "task_cmd",
  "robotId": "robot_001",
  "dataJson": {
    "taskCmd": {
      "taskId": "task_20231201_001",
      "taskName": "日常巡检任务",
      "robotMode": "normal",
      "generateTime": "2023-12-01T09:00:00",
      "stationTasks": [
        {
          "station_id": "station1",
          "sort": 1,
          "name": "服务器机房",
          "agv_marker": "point_001",
          "robot_pos": [0, 0, 0, 0, 0, 0],
          "ext_pos": [0, 0, 0, 0],
          "operation_config": {
            "operation_mode": "capture",
            "door_ip": "192.168.1.100",
            "device_id": "camera_001"
          }
        }
      ]
    }
  }
}
```

### 6.2 上行消息示例（机器人→服务器）

**机器人状态上报：**
```json
{
  "msgId": "msg_001",
  "msgTime": 1672531215000,
  "msgType": "robot_status",
  "robotId": "robot_001",
  "dataJson": {
    "batteryInfo": {
      "power_percent": 85.5,
      "charge_status": "放电中"
    },
    "positionInfo": {
      "AGVPositionInfo": [10.2, 5.3, 45.0],
      "ARMPositionInfo": [0.1, 0.2, 0.3, 0.4, 0.5, 0.6],
      "EXTPositionInfo": [0.0, 0.0, 0.0, 0.0],
      "targetPoint": "point_001",
      "pointId": null
    },
    "taskInfo": [
      {
        "task_id": "task_20231201_001",
        "station": { /* ... */ },
        "priority": 1,
        "status": "running",
        "created_at": "2023-12-01T09:00:00",
        "started_at": "2023-12-01T09:05:00",
        "completed_at": null,
        "retry_count": 0,
        "max_retries": 3,
        "error_message": null,
        "metadata": {}
      }
    ],
    "systemStatus": {
      "move_status": "running",
      "is_connected": true,
      "soft_estop_status": false,
      "hard_estop_status": false,
      "estop_status": false
    }
  }
}
```

## 7. 使用指南

### 7.1 开发建议

1. **消息ID生成**：建议使用UUID或时间戳+随机数确保唯一性
2. **时间同步**：确保机器人和服务器时间同步，建议使用NTP服务
3. **错误处理**：所有命令都应收到响应，超时或无响应需重试机制
4. **数据序列化**：使用提供的 `to_dict()` 和 `to_json()` 方法确保格式一致

### 7.2 通信流程

1. **任务下发流程**：
   - 服务器创建 `TaskCmd` → 包装为 `CommandEnvelope` → 发送给机器人
   - 机器人执行任务 → 创建 `MessageEnvelope` 上报状态 → 服务器接收处理

2. **状态上报流程**：
   - 机器人周期性采集状态 → 创建对应 `MessageEnvelope` → 发送给服务器
   - 服务器解析处理 → 必要时下发控制命令

### 7.3 注意事项

- 所有时间戳使用毫秒级Unix时间戳
- JSON序列化时确保编码为UTF-8
- 枚举值传输使用字符串形式（`.value`属性）
- 可选字段在JSON中可省略或设置为`null`
