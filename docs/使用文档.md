# 巡检机器人控制系统使用文档

## 1. 系统简介

### 1.1 系统概述

巡检机器人控制系统是一个用于管理和控制巡检机器人的核心系统，负责接收后台指令、执行任务、回传状态信息等功能。系统支持多种工作模式，能够处理复杂的巡检任务和服务任务。

### 1.2 主要功能

- **指令接收与解析**：接收后台发送的指令，解析后执行相应操作
- **任务管理**：管理任务队列，按优先级和顺序执行任务
- **状态回传**：定时向后台回传机器人状态、环境数据和设备信息
- **多模式支持**：支持inspection（巡检）和service（服务）两种工作模式
- **错误处理**：处理各种错误场景，确保系统稳定运行
- **数据持久化**：将任务信息和通信数据保存到数据库

### 1.3 适用场景

- 工业设施巡检
- 实验室巡检
- 仓库巡检
- 服务机器人
- 其他需要自动化巡检的场景

## 2. 安装与配置

### 2.1 硬件要求

- **计算机**：
  - CPU：Intel Core i5或更高
  - 内存：4GB或更高
  - 存储：10GB或更高可用空间
  - 操作系统：Windows 10/11、Linux（Ubuntu 18.04+）、macOS

- **机器人硬件**：
  - AGV机器人
  - 机械臂（可选）
  - 传感器（可选）

### 2.2 软件要求

- **Python**：Python 3.7或更高版本
- **依赖库**：系统使用Python标准库，无需额外安装依赖

### 2.3 安装步骤

1. **获取代码**：
   ```bash
   git clone <仓库地址>
   cd <仓库目录>
   ```

2. **配置文件**：
   - 复制 `conf/control.json.example` 为 `conf/control.json`
   - 根据实际需求修改配置文件

3. **验证安装**：
   ```bash
   python RobotControlSystem.py --test
   ```

### 2.4 配置说明

配置文件 `conf/control.json` 包含以下主要配置项：

| 配置项 | 描述 | 默认值 |
|--------|------|--------|
| robot_id | 机器人唯一标识 | ROBOT_001 |
| use_mock | 是否使用Mock机器人 | true |
| robot_config.success_rate | 机器人操作成功率 | 0.95 |
| robot_config.latency | 操作延迟（秒） | 0.1 |
| report_interval.status | 状态上报间隔（秒） | 10 |
| report_interval.environment | 环境数据上报间隔（秒） | 30 |

## 3. 系统启动与关闭

### 3.1 系统启动

#### 3.1.1 使用默认配置启动

```bash
python RobotControlSystem.py
```

#### 3.1.2 指定配置文件启动

```bash
python RobotControlSystem.py --config <配置文件路径>
```

#### 3.1.3 后台启动

```bash
nohup python RobotControlSystem.py > robot.log 2>&1 &
```

### 3.2 系统关闭

#### 3.2.1 正常关闭

- 在终端中按 `Ctrl+C`
- 系统会自动执行清理工作，关闭所有线程和资源

#### 3.2.2 强制关闭

```bash
pkill -f "python RobotControlSystem.py"
```

**注意**：强制关闭可能导致资源未正确释放，建议使用正常关闭方式。

## 4. 系统操作

### 4.1 指令格式

系统接收的指令格式为JSON，包含以下字段：

```json
{
  "cmdId": "唯一消息ID",
  "cmdTime": "消息时间戳（毫秒）",
  "cmdType": "命令类型",
  "robotId": "机器人ID",
  "dataJson": "实际命令数据"
}
```

### 4.2 常用指令

#### 4.2.1 任务下发指令

```json
{
  "cmdId": "TASK_001",
  "cmdTime": 1766306944000,
  "cmdType": "task_cmd",
  "robotId": "ROBOT_001",
  "dataJson": {
    "taskCmd": {
      "taskId": "INSPECTION_001",
      "taskName": "实验室巡检任务",
      "robotMode": "inspection",
      "stationTasks": [
        {
          "station_id": "station_1",
          "sort": 1,
          "name": "站点1",
          "agv_marker": "marker_1",
          "robot_pos": [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
          "ext_pos": [0.0, 0.0, 0.0, 0.0],
          "operation_config": {
            "operation_mode": "capture",
            "device_id": "device_1"
          }
        }
      ]
    }
  }
}
```

#### 4.2.2 模式切换指令

```json
{
  "cmdId": "MODE_001",
  "cmdTime": 1766306944000,
  "cmdType": "robot_mode_cmd",
  "robotId": "ROBOT_001",
  "dataJson": {
    "robotModeCmd": {
      "robotMode": "service"
    }
  }
}
```

#### 4.2.3 充电指令

```json
{
  "cmdId": "CHARGE_001",
  "cmdTime": 1766306944000,
  "cmdType": "charge_cmd",
  "robotId": "ROBOT_001",
  "dataJson": {
    "chargeCmd": {
      "charge": true
    }
  }
}
```

### 4.3 状态查看

#### 4.3.1 查看系统日志

```bash
tail -f robot.log
```

#### 4.3.2 查看数据库

```bash
# 使用sqlite3查看数据库
sqlite3 tasks.db

# 查看任务列表
SELECT * FROM tasks;

# 查看接收的消息
SELECT * FROM robot_received_messages;

# 查看发送的消息
SELECT * FROM robot_sent_messages;
```

## 5. 工作模式说明

### 5.1 巡检模式（inspection）

#### 5.1.1 模式特点

- 后台一次性发送一个站点任务队列
- 机器人按照顺序执行站点任务
- 每完成一个站点任务后回传一次device_data
- robot_status和environment_data按照定时发送

#### 5.1.2 适用场景

- 定期巡检
- 大规模设施巡检
- 标准化巡检流程

### 5.2 服务模式（service）

#### 5.2.1 模式特点

- 后台单个发送站点任务
- 机器人到达后回传ArriveServicePointInfo信息
- 后台根据回传信息做出其他响应
- 适用于需要人工干预的场景

#### 5.2.2 适用场景

- 临时任务
- 紧急巡检
- 需要人工确认的任务

## 6. 状态监控

### 6.1 状态类型

系统回传的状态信息包括以下类型：

| 状态类型 | 描述 | 上报频率 |
|----------|------|----------|
| robot_status | 机器人状态 | 每10秒 |
| device_data | 设备巡检数据 | 任务完成后 |
| environment_data | 环境数据 | 每30秒 |
| arrive_server_point | 到达服务点 | 到达后 |

### 6.2 状态格式

状态信息的JSON格式示例：

```json
{
  "msgId": "MSG_001",
  "msgTime": 1766306944000,
  "msgType": "robot_status",
  "robotId": "ROBOT_001",
  "dataJson": {
    "batteryInfo": {
      "power_percent": 100.0,
      "charge_status": "discharging"
    },
    "positionInfo": {
      "AGVPositionInfo": [0.0, 0.0, 0.0],
      "ARMPositionInfo": [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
      "EXTPositionInfo": [0.0, 0.0, 0.0, 0.0],
      "targetPoint": "marker_1"
    },
    "taskInfo": [],
    "systemStatus": {
      "move_status": "idle",
      "is_connected": true,
      "soft_estop_status": false,
      "hard_estop_status": false,
      "estop_status": false
    }
  }
}
```

### 6.3 状态监控工具

#### 6.3.1 使用日志监控

```bash
grep "robot_status" robot.log
```

#### 6.3.2 使用数据库监控

```bash
sqlite3 tasks.db "SELECT * FROM robot_sent_messages WHERE msg_type='robot_status' ORDER BY sent_at DESC LIMIT 10;"
```

## 7. 常见问题与解决

### 7.1 通信问题

#### 7.1.1 无法连接到后台

**问题**：系统启动后无法连接到后台服务器

**可能原因**：
- 后台服务器未运行
- 网络连接问题
- 防火墙设置

**解决方案**：
- 检查后台服务器是否正常运行
- 测试网络连接：`ping <后台服务器地址>`
- 检查防火墙设置，确保通信端口已开放

#### 7.1.2 消息发送失败

**问题**：系统无法发送消息到后台

**可能原因**：
- 后台服务器不可用
- 消息格式错误
- 通信协议不匹配

**解决方案**：
- 检查后台服务器状态
- 检查消息格式是否符合要求
- 检查通信协议配置

### 7.2 任务执行问题

#### 7.2.1 任务无法开始

**问题**：任务已接收，但无法开始执行

**可能原因**：
- 机器人处于错误状态
- 任务队列已满
- 系统资源不足

**解决方案**：
- 检查机器人状态：`python RobotControlSystem.py --status`
- 查看任务队列：`sqlite3 tasks.db "SELECT * FROM tasks WHERE status='pending';"`
- 检查系统资源：`top`

#### 7.2.2 任务执行失败

**问题**：任务执行失败，显示错误信息

**可能原因**：
- 机器人操作失败
- 传感器数据异常
- 环境条件不满足

**解决方案**：
- 查看详细错误日志
- 检查机器人状态
- 检查传感器数据
- 重试任务

### 7.3 数据库问题

#### 7.3.1 数据库连接失败

**问题**：系统无法连接到数据库

**可能原因**：
- 数据库文件不存在
- 权限问题
- 数据库文件损坏

**解决方案**：
- 检查数据库文件是否存在
- 检查文件权限：`chmod 644 tasks.db`
- 重新创建数据库：`python RobotControlSystem.py --reset-db`

#### 7.3.2 数据库性能问题

**问题**：数据库操作缓慢

**可能原因**：
- 数据库文件过大
- 缺少索引
- 系统资源不足

**解决方案**：
- 清理过期数据
- 优化数据库索引
- 增加系统资源

## 8. 维护与保养

### 8.1 定期维护

| 维护项目 | 维护周期 | 维护内容 |
|----------|----------|----------|
| 日志清理 | 每周 | 清理过期日志文件 |
| 数据库备份 | 每日 | 备份数据库文件 |
| 数据库优化 | 每月 | 清理过期数据，优化索引 |
| 系统更新 | 每季度 | 更新系统代码和依赖 |

### 8.2 数据备份

```bash
# 备份数据库
cp tasks.db tasks_$(date +%Y%m%d_%H%M%S).db

# 备份配置文件
cp conf/control.json conf/control_$(date +%Y%m%d_%H%M%S).json
```

### 8.3 数据恢复

```bash
# 恢复数据库
cp tasks_backup.db tasks.db

# 恢复配置文件
cp conf/control_backup.json conf/control.json
```

## 9. 安全注意事项

### 9.1 系统安全

- 定期更新系统代码和依赖
- 使用强密码保护数据库
- 限制数据库访问权限
- 启用日志审计

### 9.2 通信安全

- 使用加密通信协议（如WSS/MQTTS）
- 实现消息认证和授权
- 防止消息篡改
- 定期更换加密密钥

### 9.3 操作安全

- 确保机器人在安全区域内运行
- 避免在机器人运行时进行维护
- 定期检查机器人硬件状态
- 确保操作人员经过培训

## 10. 技术支持

### 10.1 联系方式

- 技术支持邮箱：support@example.com
- 技术支持电话：+86-XXX-XXXXXXX
- 官方网站：https://www.example.com

### 10.2 问题反馈

当遇到问题时，请提供以下信息：

- 系统版本
- 错误日志
- 问题描述
- 复现步骤
- 系统配置

### 10.3 更新日志

#### v1.0.0（2025-12-21）
- 初始版本
- 实现核心功能
- 支持两种工作模式
- 实现通信机制
- 支持Mock机器人

#### v1.0.1（计划）
- 优化通信性能
- 增加更多错误处理
- 实现Web监控界面
- 支持更多操作模式

## 11. 附录

### 11.1 命令类型列表

| 命令类型 | 功能描述 |
|----------|----------|
| TASK_CMD | 任务下发 |
| ROBOT_MODE_CMD | 机器人模式切换 |
| JOY_CONTROL_CMD | 摇杆控制 |
| CHARGE_CMD | 充电命令 |
| SET_MARKER_CMD | 设置标记 |

### 11.2 消息类型列表

| 消息类型 | 功能描述 |
|----------|----------|
| robot_status | 机器人状态 |
| device_data | 巡检设备状态 |
| environment_data | 巡检环境信息 |
| arrive_server_point | 到达服务点 |

### 11.3 任务状态列表

| 任务状态 | 描述 |
|----------|------|
| pending | 待执行 |
| running | 执行中 |
| completed | 已完成 |
| failed | 执行失败 |
| skipped | 已跳过 |
| retrying | 重试中 |

### 11.4 机器人状态列表

| 机器人状态 | 描述 |
|------------|------|
| idle | 空闲 |
| moving | AGV移动中 |
| arm_operating | 机械臂操作中 |
| ext_operating | 外部轴操作中 |
| door_operating | 门操作中 |
| error | 错误 |
| charging | 充电中 |
| setup | 系统初始化中 |

## 12. 术语表

| 术语 | 解释 |
|------|------|
| AGV | 自动引导车（Automated Guided Vehicle） |
| MQTT | 消息队列遥测传输协议（Message Queuing Telemetry Transport） |
| WebSocket | 一种全双工通信协议 |
| Mock | 模拟，用于测试环境 |
| JSON | JavaScript对象表示法，一种数据交换格式 |
| SQLite | 一种嵌入式关系型数据库 |

---

**文档版本**：v1.0.0
**发布日期**：2025-12-21
**版权所有**：巡检机器人控制系统开发团队
**保留所有权利**